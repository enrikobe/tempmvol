<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Controllo Vasche">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#C44536">
    <title>Gestione Controllo Vasche - Cantina</title>
    <style>
        :root {
            --primary: #C44536;
            --primary-light: #D95F4F;
            --secondary: #E8927C;
            --bg-main: #FAFAFA;
            --bg-card: #FFFFFF;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-light: #E5E5E5;
            --border-medium: #CCCCCC;
            --success: #5CB85C;
            --warning: #F0AD4E;
            --danger: #D9534F;
            --star: #FFB900;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);

            --keypad-bg: rgba(40, 40, 40, 0.95);
            --keypad-btn: rgba(60, 60, 60, 0.8);
            --keypad-btn-active: rgba(90, 90, 90, 1);
            --keypad-height: 280px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }
        .desktop-view input, .desktop-view textarea { user-select: text; -webkit-user-select: text; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            width: 100vw;
        }

        /* UTILS */
        .hidden { display: none !important; }

        /* SYNC STATUS */
        .sync-status {
            position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; color: white; transition: all 0.3s;
        }
        .sync-status.synced { background: var(--success); }
        .sync-status.offline { background: var(--danger); }
        .sync-status.syncing { background: var(--warning); }

        /* DESKTOP LAYOUT */
        #desktopView { padding: 20px; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
        .desktop-header { background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .desktop-header h1 { color: var(--primary); font-size: 24px; }

        .desktop-toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: 0.2s; box-shadow: var(--shadow-sm); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border-medium); color: var(--text-primary); }
        button:active { transform: scale(0.98); }

        /* TABLE */
        .table-container { background: var(--bg-card); border-radius: 8px; box-shadow: var(--shadow-sm); flex: 1; overflow: auto; position: relative; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        .data-table th { position: sticky; top: 0; background: #f5f5f5; z-index: 10; padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 2px solid var(--border-light); }
        .data-table td { padding: 10px 12px; border-bottom: 1px solid var(--border-light); }
        .data-table tr:hover { background: #f9f9f9; }
        .data-table input { width: 100%; padding: 6px; border: 1px solid transparent; border-radius: 4px; background: transparent; }
        .data-table input:hover { background: white; border-color: var(--border-light); }
        .data-table input:focus { background: white; border-color: var(--primary); outline: none; }

        .date-group-header { background: #EFEFEF; font-weight: bold; padding: 10px 20px; cursor: pointer; color: var(--primary); }
        .copy-action { cursor: pointer; }
        .copy-action:hover { color: var(--primary); }
        .copy-action::after { content: ' üìã'; font-size: 12px; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
        .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--primary); }
        .modal-body label { display: block; margin-top: 12px; margin-bottom: 4px; font-weight: 500; font-size: 14px; }
        .modal-body input { width: 100%; padding: 10px; border: 1px solid var(--border-medium); border-radius: 6px; font-size: 16px; }
        .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }

        /* TABLET VIEW */
        #tabletView { width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-main); }
        .tablet-header { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 15px; text-align: center; box-shadow: var(--shadow-md); position: relative; z-index: 100; }
        .tablet-header h1 { font-size: 18px; margin: 0; }
        .tablet-header .date { font-size: 13px; opacity: 0.9; margin-top: 4px; }

        .tablet-list { flex: 1; overflow-y: auto; padding-bottom: 300px; -webkit-overflow-scrolling: touch; }
        .tablet-row { background: white; padding: 12px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 10px; }
        .tablet-row.priority { background: #FFF9E6; }
        .tablet-row.completed { background: #F0F9F0; }
        .tablet-row.focused { background: #E3F2FD; border-left: 4px solid var(--primary); }

        .t-info { flex: 1; }
        .t-vasca { font-size: 22px; font-weight: bold; color: var(--primary); }
        .t-desc { font-size: 14px; color: var(--text-secondary); margin-top: 2px; }

        .t-inputs { display: flex; gap: 8px; }
        .t-input { width: 80px; height: 50px; border: 2px solid var(--border-light); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; background: #FAFAFA; color: #333; cursor: pointer; }
        .t-input.active { border-color: var(--primary); background: white; color: var(--primary); box-shadow: 0 0 0 3px rgba(196,69,54,0.1); }
        .t-input.filled { background: #E8F5E9; border-color: var(--success); color: var(--success); }

        /* KEYPAD */
        #keypadOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.2); z-index: 999; display: none; }
        .keypad-container { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--keypad-bg); z-index: 1000; transform: translateY(100%); transition: transform 0.25s cubic-bezier(0.1, 0.9, 0.2, 1); padding: 10px; padding-bottom: calc(10px + var(--safe-bottom)); border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .keypad-container.visible { transform: translateY(0); }

        .keypad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 500px; margin: 0 auto; }
        .key-btn { background: var(--keypad-btn); color: white; border-radius: 12px; height: 55px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 400; cursor: pointer; transition: 0.1s; border: 1px solid rgba(255,255,255,0.1); }
        .key-btn:active { background: var(--keypad-btn-active); transform: scale(0.96); }
        .key-btn[data-key="backspace"] { background: rgba(255, 59, 48, 0.3); }

        /* LANDSCAPE WARNING */
        #landscapeWarning { position: fixed; inset: 0; background: var(--primary); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; text-align: center; }
        @media (orientation: landscape) and (max-width: 1024px) { #tabletView { display: none; } #landscapeWarning { display: flex; } }
    </style>
</head>
<body>

<!-- VIEW CONTAINER -->
<div id="app"></div>

<!-- TEMPLATES -->
<template id="desktop-template">
    <div id="desktopView">
        <div class="desktop-header">
            <h1>üç∑ Controllo Vasche - Desktop</h1>
            <div id="syncStatusDesktop" class="sync-status synced">‚òÅÔ∏è</div>
        </div>
        <div class="desktop-toolbar">
            <button class="btn-primary" onclick="app.showAddModal()">‚ûï Nuova Vasca</button>
            <button class="btn-secondary" onclick="app.showBulkEdit()">‚úèÔ∏è Modifica Selezionate</button>
            <button class="btn-outline" onclick="app.deleteSelected()">üóëÔ∏è Elimina</button>
            <button class="btn-outline" onclick="app.exportCSV()">üíæ Esporta CSV</button>
            <input type="text" id="searchBar" placeholder="üîç Cerca..." style="padding: 10px; border: 1px solid #ccc; border-radius: 6px;" onkeyup="app.renderDesktop()">
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" onchange="app.toggleSelectAll(this)"></th>
                        <th>Vasca</th>
                        <th>Vino</th>
                        <th>Uva</th>
                        <th class="copy-action" onclick="app.copyValues('temperatura')">Temp</th>
                        <th class="copy-action" onclick="app.copyValues('mVol')">M.Vol</th>
                        <th>Data</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody id="desktopTableBody"></tbody>
            </table>
        </div>
    </div>
</template>

<template id="tablet-template">
    <div id="tabletView">
        <div class="tablet-header">
            <h1>Controllo Vasche</h1>
            <div class="date" id="tabletDateDisplay">--/--/----</div>
            <div id="syncStatusTablet" class="sync-status synced">‚òÅÔ∏è</div>
        </div>
        <div class="tablet-list" id="tabletList"></div>
    </div>
    <div id="keypadOverlay"></div>
    <div class="keypad-container" id="keypad">
        <div class="keypad-grid">
            <div class="key-btn" data-key="1">1</div>
            <div class="key-btn" data-key="2">2</div>
            <div class="key-btn" data-key="3">3</div>
            <div class="key-btn" data-key="4">4</div>
            <div class="key-btn" data-key="5">5</div>
            <div class="key-btn" data-key="6">6</div>
            <div class="key-btn" data-key="7">7</div>
            <div class="key-btn" data-key="8">8</div>
            <div class="key-btn" data-key="9">9</div>
            <div class="key-btn" data-key=",">,</div>
            <div class="key-btn" data-key="0">0</div>
            <div class="key-btn" data-key="backspace">‚å´</div>
        </div>
    </div>
</template>

<div id="landscapeWarning">
    <div style="font-size: 60px; margin-bottom: 20px;">üì±</div>
    <h2>Ruota il dispositivo</h2>
    <p>Usa la modalit√† verticale</p>
</div>

<!-- FIREBASE SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBvjIO8b0hBI0DD_m-VF-Vr6LCwcAFpGkw",
        authDomain: "tempmvol.firebaseapp.com",
        projectId: "tempmvol",
        storageBucket: "tempmvol.firebasestorage.app",
        messagingSenderId: "555620995865",
        appId: "1:555620995865:web:52bc7fef7188bc27112b88"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Persistence per offline support nativo
    enableIndexedDbPersistence(db).catch((err) => {
        if (err.code == 'failed-precondition') {
            console.warn('Persistence failed: Multiple tabs open');
        } else if (err.code == 'unimplemented') {
            console.warn('Persistence not supported');
        }
    });

    window.db = db;
    window.fs = { collection, doc, setDoc, onSnapshot, writeBatch };
    console.log("üî• Firebase init done");

    // Avvia app dopo init firebase
    window.app.init();
</script>

<script>
window.app = {
    data: [],
    view: 'desktop',
    activeCell: null,
    currentValue: '',

    init: function() {
        this.detectView();
        this.loadLocal();
        this.render();
        this.initFirebaseListener();
        this.setupEvents();
    },

    detectView: function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('view') === 'tablet' || (window.innerWidth < 1024 && 'ontouchstart' in window)) {
            this.view = 'tablet';
        }
    },

    loadLocal: function() {
        const stored = localStorage.getItem('cantina_data');
        if (stored) this.data = JSON.parse(stored);
    },

    save: function() {
        localStorage.setItem('cantina_data', JSON.stringify(this.data));
        this.syncToFirebase();
        this.render();
    },

    // FIREBASE LOGIC (RIPRISTINATA OLD STYLE)
    initFirebaseListener: function() {
        if (!window.db) return;

        const { collection, onSnapshot } = window.fs;
        // Listener sempre attivo
        onSnapshot(collection(window.db, 'vasche'), (snapshot) => {
            const remoteData = [];
            snapshot.forEach(doc => remoteData.push(doc.data()));

            // Semplice check: se lunghezza o contenuto diverso, aggiorna tutto
            // "Server Wins" strategy per semplicit√† in questo contesto
            if (JSON.stringify(remoteData) !== JSON.stringify(this.data)) {
                console.log('üì• Firebase update received');
                this.data = remoteData;
                localStorage.setItem('cantina_data', JSON.stringify(this.data)); // Salva senza triggerare sync loop
                this.render();
                this.updateStatus('synced');
            }
        }, (error) => {
            console.error("Firebase Error:", error);
            this.updateStatus('offline');
        });
    },

    syncToFirebase: function() {
        if (!window.db) return;

        this.updateStatus('syncing');
        const { doc, writeBatch } = window.fs;
        const batch = writeBatch(window.db);

        // Sovrascrivi intera collezione (semplificato e robusto per piccole moli di dati)
        this.data.forEach(item => {
            const ref = doc(window.db, 'vasche', String(item.id));
            batch.set(ref, item);
        });

        batch.commit()
            .then(() => {
                console.log('üì§ Sync success');
                this.updateStatus('synced');
            })
            .catch(err => {
                console.error('Sync fail', err);
                this.updateStatus('offline');
            });
    },

    updateStatus: function(status) {
        const els = document.querySelectorAll('.sync-status');
        els.forEach(el => {
            el.className = 'sync-status ' + status;
            el.innerHTML = status === 'synced' ? '‚òÅÔ∏è' : (status === 'syncing' ? 'üîÑ' : '‚ö†Ô∏è');
        });
    },

    // RENDER LOGIC
    render: function() {
        const container = document.getElementById('app');
        if (this.view === 'desktop') {
            if (!document.getElementById('desktopView')) {
                container.innerHTML = document.getElementById('desktop-template').innerHTML;
            }
            this.renderDesktop();
        } else {
            if (!document.getElementById('tabletView')) {
                container.innerHTML = document.getElementById('tablet-template').innerHTML;
                this.setupKeypad(); // Setup eventi keypad solo se in tablet view
            }
            this.renderTablet();
        }
    },

    renderDesktop: function() {
        const tbody = document.getElementById('desktopTableBody');
        if (!tbody) return;

        const search = document.getElementById('searchBar').value.toLowerCase();

        // Group by date
        const grouped = {};
        this.data.forEach(item => {
            if (search && !JSON.stringify(item).toLowerCase().includes(search)) return;
            const d = item.data || 'Senza Data';
            if (!grouped[d]) grouped[d] = [];
            grouped[d].push(item);
        });

        // Sort dates desc
        const dates = Object.keys(grouped).sort((a,b) => {
            if (a === 'Senza Data') return 1;
            if (b === 'Senza Data') return -1;
            return this.parseDate(b) - this.parseDate(a);
        });

        let html = '';
        dates.forEach(date => {
            html += `<tr class="date-header"><td colspan="8" class="date-group-header">${date}</td></tr>`;
            grouped[date].forEach(item => {
                html += `
                <tr>
                    <td><input type="checkbox" class="row-sel" data-id="${item.id}"></td>
                    <td><input type="text" value="${item.vasca}" onchange="app.updateItem(${item.id}, 'vasca', this.value)"></td>
                    <td><input type="text" value="${item.tipoVino || ''}" onchange="app.updateItem(${item.id}, 'tipoVino', this.value)"></td>
                    <td><input type="text" value="${item.uva || ''}" onchange="app.updateItem(${item.id}, 'uva', this.value)"></td>
                    <td><input type="text" value="${item.temperatura || ''}" onchange="app.updateItem(${item.id}, 'temperatura', this.value)"></td>
                    <td><input type="text" value="${item.mVol || ''}" onchange="app.updateItem(${item.id}, 'mVol', this.value)"></td>
                    <td><input type="date" value="${this.formatDateInput(item.data)}" onchange="app.updateItem(${item.id}, 'data', app.formatDateOutput(this.value))"></td>
                    <td><input type="text" value="${item.note || ''}" onchange="app.updateItem(${item.id}, 'note', this.value)"></td>
                </tr>`;
            });
        });
        tbody.innerHTML = html;
    },

    renderTablet: function() {
        const list = document.getElementById('tabletList');
        if (!list) return;

        const today = this.getToday();
        document.getElementById('tabletDateDisplay').innerText = today;

        const items = this.data.filter(i => i.data === today);
        items.sort((a,b) => parseInt(a.vasca) - parseInt(b.vasca));

        if (items.length === 0) {
            list.innerHTML = '<div style="padding:40px; text-align:center; color:#999">Nessuna vasca per oggi</div>';
            return;
        }

        let html = '';
        items.forEach(item => {
            const isCompleted = item.temperatura && item.mVol;
            const cls = isCompleted ? 'completed' : (item.priority ? 'priority' : '');

            html += `
            <div class="tablet-row ${cls}" id="row-${item.id}">
                <div class="t-info">
                    <div class="t-vasca">${item.vasca}</div>
                    <div class="t-desc">${item.tipoVino || ''} ${item.uva || ''}</div>
                </div>
                <div class="t-inputs">
                    <div class="t-input ${item.temperatura ? 'filled' : ''}" onclick="app.openKeypad(${item.id}, 'temperatura', this)">${item.temperatura || '--'}</div>
                    <div class="t-input ${item.mVol ? 'filled' : ''}" onclick="app.openKeypad(${item.id}, 'mVol', this)">${item.mVol || '--'}</div>
                </div>
            </div>`;
        });
        list.innerHTML = html;
    },

    // UTILS
    getToday: function() {
        const d = new Date();
        return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    },
    parseDate: function(str) {
        if (!str) return 0;
        const [d, m, y] = str.split('/');
        return new Date(y, m-1, d).getTime();
    },
    formatDateInput: function(str) {
        if (!str) return '';
        const [d, m, y] = str.split('/');
        return `${y}-${m}-${d}`;
    },
    formatDateOutput: function(iso) {
        if (!iso) return '';
        const [y, m, d] = iso.split('-');
        return `${d}/${m}/${y}`;
    },

    // ACTIONS
    updateItem: function(id, field, val) {
        const item = this.data.find(i => i.id === id);
        if (item) {
            item[field] = val;
            this.save();
        }
    },

    showAddModal: function() {
        // Simple prompt replacement for stability
        const vasca = prompt("Numero Vasca:");
        if (!vasca) return;

        const newItem = {
            id: Date.now(),
            vasca: vasca,
            data: this.getToday(),
            tipoVino: '', uva: '', temperatura: '', mVol: '', priority: false
        };
        this.data.push(newItem);
        this.save();
    },

    deleteSelected: function() {
        const checked = document.querySelectorAll('.row-sel:checked');
        if (checked.length === 0) return alert("Seleziona righe da eliminare");
        if (!confirm("Eliminare selezionate?")) return;

        const ids = Array.from(checked).map(c => parseInt(c.dataset.id));
        this.data = this.data.filter(i => !ids.includes(i.id));
        this.save();
    },

    // FIX: COPY VALUES (FROM PREV DATE TO LATEST DATE)
    copyValues: function(field) {
        const dates = [...new Set(this.data.map(i => i.data || ''))].filter(d => d);
        dates.sort((a,b) => this.parseDate(b) - this.parseDate(a));

        if (dates.length < 2) return alert("Servono almeno 2 date per copiare");

        const targetDate = dates[0]; // Newest (Today)
        const sourceDate = dates[1]; // Previous (Yesterday)

        const targetItems = this.data.filter(i => i.data === targetDate);
        const sourceItems = this.data.filter(i => i.data === sourceDate);

        let count = 0;
        targetItems.forEach(tItem => {
            const sItem = sourceItems.find(s => s.vasca === tItem.vasca);
            if (sItem && sItem[field]) {
                tItem[field] = sItem[field];
                count++;
            }
        });

        if (count > 0) {
            this.save();
            alert(`Copiati ${count} valori da ${sourceDate} a ${targetDate}`);
        } else {
            alert("Nessuna corrispondenza trovata tra le date");
        }
    },

    // FIX: BULK EDIT
    showBulkEdit: function() {
        const checked = document.querySelectorAll('.row-sel:checked');
        if (checked.length === 0) return alert("Seleziona righe");

        const field = prompt("Quale campo modificare? (vino, uva, data, note)");
        if (!field) return;

        // Map user friendly names to keys
        const keyMap = { 'vino': 'tipoVino', 'uva': 'uva', 'data': 'data', 'note': 'note' };
        const key = keyMap[field.toLowerCase()] || field;

        const val = prompt(`Nuovo valore per ${field}:`);
        if (val === null) return;

        const ids = Array.from(checked).map(c => parseInt(c.dataset.id));
        this.data.forEach(item => {
            if (ids.includes(item.id)) {
                item[key] = val;
            }
        });
        this.save();
    },

    toggleSelectAll: function(cb) {
        document.querySelectorAll('.row-sel').forEach(c => c.checked = cb.checked);
    },

    // TABLET KEYPAD & EVENTS
    setupEvents: function() {
        // General setup if needed
    },

    setupKeypad: function() {
        const overlay = document.getElementById('keypadOverlay');
        const keypad = document.getElementById('keypad');

        // Overlay click closes
        overlay.onclick = (e) => {
            e.stopPropagation();
            this.closeKeypad();
        };

        // Keypad buttons
        document.querySelectorAll('.key-btn').forEach(btn => {
            const key = btn.dataset.key;

            // Handle both touch and mouse
            const handlePress = (e) => {
                e.preventDefault(); // Prevent ghost clicks
                e.stopPropagation();

                // Visual feedback
                btn.style.transform = "scale(0.95)";
                setTimeout(() => btn.style.transform = "scale(1)", 100);

                this.handleKey(key);
            };

            btn.addEventListener('touchstart', handlePress, {passive: false});
            btn.addEventListener('mousedown', handlePress);
        });
    },

    openKeypad: function(id, field, el) {
        // Highlight row
        document.querySelectorAll('.tablet-row').forEach(r => r.classList.remove('focused'));
        document.getElementById('row-'+id).classList.add('focused');

        // Highlight cell
        if (this.activeCell) this.activeCell.classList.remove('active');
        this.activeCell = el;
        el.classList.add('active');

        // State
        this.activeId = id;
        this.activeField = field;
        const item = this.data.find(i => i.id === id);
        this.currentValue = item[field] || '';

        // Show
        document.getElementById('keypadOverlay').style.display = 'block';
        document.getElementById('keypad').classList.add('visible');
    },

    closeKeypad: function() {
        document.getElementById('keypadOverlay').style.display = 'none';
        document.getElementById('keypad').classList.remove('visible');
        if (this.activeCell) this.activeCell.classList.remove('active');
        document.querySelectorAll('.tablet-row').forEach(r => r.classList.remove('focused'));

        // Save on close
        if (this.activeId) {
            const item = this.data.find(i => i.id === this.activeId);
            if (item) {
                item[this.activeField] = this.currentValue;
                this.save();
            }
        }
        this.activeId = null;
    },

    handleKey: function(key) {
        if (!this.activeId) return;

        if (key === 'backspace') {
            this.currentValue = this.currentValue.slice(0, -1);
        } else {
            this.currentValue += key;
        }

        // Live update UI
        if (this.activeCell) this.activeCell.innerText = this.currentValue;

        // Live update data (optional, but good for safety)
        // const item = this.data.find(i => i.id === this.activeId);
        // if(item) item[this.activeField] = this.currentValue;
    }
};
</script>
</body>
</html>